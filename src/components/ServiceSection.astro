---
interface Props {
  title: string;
  description?: string;
  image?: string;
  images?: string[];
  href: string;
  reverse?: boolean;
}

const { title, description, image, images, href, reverse = false } = Astro.props;
const galleryImages = images && images.length > 0 ? images : image ? [image] : [];
const hasGallery = galleryImages.length > 1;
---

<section class:list={['service-section', { 'service-section--reverse': reverse }]}>
  <div class="service-section__inner container">
    <div class="service-section__text" data-animate={reverse ? "from-right" : "from-left"}>
      <h2 class="service-section__title">{title}</h2>
      {description && <p class="service-section__desc">{description}</p>}
      <a href={href} class="btn btn--outline service-section__btn">Dowiedz się więcej</a>
    </div>
    <div class="service-section__media" data-animate={reverse ? "from-left" : "from-right"}>
      {hasGallery ? (
        <div class="slider" data-slider>
          <div class="slider__track" data-slider-track>
            {galleryImages.map((img, i) => (
              <img
                src={img}
                alt={`${title} ${i + 1}`}
                class="slider__slide"
                loading="lazy"
                data-slide-index={i}
              />
            ))}
          </div>
          <button class="slider__arrow slider__arrow--prev" data-slider-prev aria-label="Poprzednie">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <button class="slider__arrow slider__arrow--next" data-slider-next aria-label="Następne">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
          <span class="slider__counter" data-slider-counter>1 / {galleryImages.length}</span>
          <div class="slider__data" data-slider-images style="display:none">{JSON.stringify(galleryImages)}</div>
        </div>
      ) : (
        <div class="service-section__image">
          <img src={galleryImages[0]} alt={title} loading="lazy" />
        </div>
      )}
    </div>
  </div>
</section>

{hasGallery && (
  <div class="lightbox" data-lightbox aria-hidden="true">
    <button class="lightbox__close" data-lightbox-close aria-label="Zamknij">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    <button class="lightbox__arrow lightbox__arrow--prev" data-lightbox-prev aria-label="Poprzednie">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <button class="lightbox__arrow lightbox__arrow--next" data-lightbox-next aria-label="Następne">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
    <img class="lightbox__img" data-lightbox-img alt="" />
    <span class="lightbox__counter" data-lightbox-counter></span>
  </div>
)}

<style>
  .service-section {
    padding: 80px 0;
  }

  .service-section:nth-child(even) {
    background: transparent;
  }

  .service-section__inner {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 56px;
    align-items: center;
  }

  .service-section--reverse .service-section__inner {
    direction: rtl;
  }

  .service-section--reverse .service-section__inner > * {
    direction: ltr;
  }

  .service-section__title {
    font-size: 2rem;
    margin-bottom: 20px;
  }

  .service-section__desc {
    color: var(--color-text-light);
    line-height: 1.7;
    margin-bottom: 28px;
    font-size: 1rem;
  }

  .service-section__btn {
    padding: 12px 28px;
    font-size: 0.9rem;
  }

  /* Single image */
  .service-section__image {
    overflow: hidden;
    border-radius: 16px;
  }

  .service-section__image img {
    width: 100%;
    aspect-ratio: 4/3;
    object-fit: cover;
    display: block;
    transition: transform 0.5s ease;
  }

  .service-section__image:hover img {
    transform: scale(1.03);
  }

  /* Slider */
  .slider {
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    aspect-ratio: 4/3;
    background: #eee;
    user-select: none;
    touch-action: pan-y;
  }

  .slider__track {
    display: flex;
    height: 100%;
    transition: transform 0.4s ease;
    will-change: transform;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  .slider__track.dragging {
    transition: none;
  }

  .slider__slide {
    flex: 0 0 100%;
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
  }

  .slider__arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.85);
    border: none;
    border-radius: 50%;
    color: #1a1a1a;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    z-index: 2;
  }

  .slider:hover .slider__arrow {
    opacity: 1;
  }

  .slider__arrow:hover {
    background: #fff;
  }

  .slider__arrow--prev { left: 10px; }
  .slider__arrow--next { right: 10px; }

  .slider__counter {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.55);
    color: #fff;
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 20px;
    font-family: var(--font-main);
    z-index: 2;
  }

  /* Lightbox */
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 2000;
    background: rgba(0, 0, 0, 0.92);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .lightbox.open {
    opacity: 1;
    visibility: visible;
  }

  .lightbox__img {
    max-width: 90vw;
    max-height: 85vh;
    object-fit: contain;
    border-radius: 4px;
    user-select: none;
  }

  .lightbox__close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.3s;
  }

  .lightbox__close:hover { opacity: 1; }

  .lightbox__arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: #fff;
    cursor: pointer;
    transition: background 0.3s;
  }

  .lightbox__arrow:hover { background: rgba(255, 255, 255, 0.25); }
  .lightbox__arrow--prev { left: 20px; }
  .lightbox__arrow--next { right: 20px; }

  .lightbox__counter {
    position: absolute;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    font-family: var(--font-main);
  }

  @media (max-width: 768px) {
    .service-section { padding: 48px 0; }

    .service-section__inner,
    .service-section--reverse .service-section__inner {
      grid-template-columns: 1fr;
      direction: ltr;
      gap: 32px;
    }

    .service-section__title { font-size: 1.6rem; }

    .slider__arrow { opacity: 0.8; }
    .lightbox__arrow--prev { left: 8px; }
    .lightbox__arrow--next { right: 8px; }
  }
</style>

<script>
  document.querySelectorAll('[data-slider]').forEach(slider => {
    const el = slider as HTMLElement;
    const track = slider.querySelector('[data-slider-track]') as HTMLElement;
    const prevBtn = slider.querySelector('[data-slider-prev]') as HTMLElement;
    const nextBtn = slider.querySelector('[data-slider-next]') as HTMLElement;
    const counter = slider.querySelector('[data-slider-counter]') as HTMLElement;
    const imagesData: string[] = JSON.parse(slider.querySelector('[data-slider-images]')!.textContent!);
    const total = imagesData.length;

    let current = 0;
    let startX = 0;
    let moveX = 0;
    let dragging = false;

    function goTo(index: number) {
      current = (index + total) % total;
      track.style.transform = `translate3d(-${current * 100}%, 0, 0)`;
      counter.textContent = `${current + 1} / ${total}`;
    }

    // Arrow buttons
    prevBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      goTo(current - 1);
    });
    nextBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      goTo(current + 1);
    });

    // Drag with mouse
    track.addEventListener('mousedown', (e) => {
      e.preventDefault();
      dragging = true;
      startX = e.clientX;
      moveX = 0;
      track.classList.add('dragging');
    });

    document.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      moveX = e.clientX - startX;
      const offset = -current * 100;
      const percent = (moveX / el.offsetWidth) * 100;
      track.style.transform = `translate3d(${offset + percent}%, 0, 0)`;
    });

    document.addEventListener('mouseup', () => {
      if (!dragging) return;
      dragging = false;
      track.classList.remove('dragging');
      const threshold = el.offsetWidth * 0.15;
      if (moveX < -threshold) goTo(current + 1);
      else if (moveX > threshold) goTo(current - 1);
      else goTo(current);
    });

    // Touch swipe
    let startY = 0;
    let direction: 'none' | 'horizontal' | 'vertical' = 'none';

    track.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      moveX = 0;
      direction = 'none';
      dragging = true;
      track.classList.add('dragging');
    }, { passive: true });

    track.addEventListener('touchmove', (e) => {
      if (!dragging) return;
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;

      if (direction === 'none') {
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 5) {
          direction = 'horizontal';
          document.documentElement.style.overflow = 'hidden';
          document.body.style.overflow = 'hidden';
        } else if (Math.abs(dy) >= Math.abs(dx) && Math.abs(dy) > 5) {
          direction = 'vertical';
          dragging = false;
          track.classList.remove('dragging');
          goTo(current);
          return;
        } else {
          return;
        }
      }

      if (direction === 'horizontal') {
        e.preventDefault();
        moveX = dx;
        const offset = -current * 100;
        const percent = (moveX / el.offsetWidth) * 100;
        track.style.transform = `translate3d(${offset + percent}%, 0, 0)`;
      }
    }, { passive: false });

    track.addEventListener('touchend', () => {
      if (direction === 'horizontal') {
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
      }
      if (!dragging) return;
      dragging = false;
      track.classList.remove('dragging');
      const threshold = el.offsetWidth * 0.15;
      if (moveX < -threshold) goTo(current + 1);
      else if (moveX > threshold) goTo(current - 1);
      else goTo(current);
    });

    track.addEventListener('touchcancel', () => {
      if (direction === 'horizontal') {
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
      }
      if (!dragging) return;
      dragging = false;
      track.classList.remove('dragging');
      goTo(current);
    });

    // Prevent native image drag
    track.addEventListener('dragstart', (e) => e.preventDefault());

    // Click on slide to open lightbox
    const section = slider.closest('.service-section')!;
    const lightbox = section.nextElementSibling as HTMLElement;
    if (!lightbox || !lightbox.classList.contains('lightbox')) return;

    const lbImg = lightbox.querySelector('[data-lightbox-img]') as HTMLImageElement;
    const lbCounter = lightbox.querySelector('[data-lightbox-counter]') as HTMLElement;
    const lbClose = lightbox.querySelector('[data-lightbox-close]');
    const lbPrev = lightbox.querySelector('[data-lightbox-prev]');
    const lbNext = lightbox.querySelector('[data-lightbox-next]');

    let lbIndex = 0;

    function updateLb() {
      lbImg.src = imagesData[lbIndex];
      lbCounter.textContent = `${lbIndex + 1} / ${total}`;
    }

    function openLb() {
      lbIndex = current;
      updateLb();
      lightbox.classList.add('open');
      lightbox.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeLb() {
      lightbox.classList.remove('open');
      lightbox.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    track.addEventListener('click', () => {
      if (Math.abs(moveX) > 5) return;
      openLb();
    });

    lbClose?.addEventListener('click', closeLb);
    lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLb(); });
    lbPrev?.addEventListener('click', () => { lbIndex = (lbIndex - 1 + total) % total; updateLb(); });
    lbNext?.addEventListener('click', () => { lbIndex = (lbIndex + 1) % total; updateLb(); });

    document.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('open')) return;
      if (e.key === 'Escape') closeLb();
      if (e.key === 'ArrowLeft') { lbIndex = (lbIndex - 1 + total) % total; updateLb(); }
      if (e.key === 'ArrowRight') { lbIndex = (lbIndex + 1) % total; updateLb(); }
    });
  });
</script>
